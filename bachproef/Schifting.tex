%%=============================================================================
%% Schifting 
%%=============================================================================

\chapter{\IfLanguageName{dutch}{Schifting}{Schifting}}
\label{ch:schifting}


\section{\IfLanguageName{dutch}{Requirements}{Requirements}}
\label{sec:Requirements}
Om te kunnen bepalen welke requirements er nodig zijn,

Elk van deze High Available PostgreSQL cluster oplossingen zal worden afgetoetst aan de requirements om ze op deze manier te evalueren. In samenspraak met Ruben Demey zijn er drie functionele requirements. Bij elke oplossing worden de requirements afgetoetst en krijgen ze een score van 1 (slecht) tot 5 (uitstekend).
% Aan de hand van MosCOW mss wel


\subsection{\IfLanguageName{dutch}{Functionele Requirements}{Functionele Requirements}}
\label{subsec:Functionele Requirements}
Een functionele requirement beschrijft hoe het systeem moet werken en wat het moet kunnen.

\subsubsection{\IfLanguageName{dutch}{Redundancy}{Redundancy}}
\label{subsubsec:Redundancy}
Om High Availability te bereiken moeten clusters aan bepaalde eisen voldoen. Het moet over redundantie beschikken om single points of failure te vermijden. 


\subsubsection{\IfLanguageName{dutch}{Failover}{Failover}}
\label{subsubsec:Failover}
Het opzetten van failover (replicatie) biedt de nodige redundantie om High Availability mogelijk te maken door ervoor te zorgen dat standby nodes beschikbaar zijn als de master of primary node ooit uitvalt. 

\subsubsection{\IfLanguageName{dutch}{Monitoring}{Monitoring}}
\label{subsubsec:Monitoring}
Monitoring is belangrijk omdat het op deze manier actief storingen kan opmerken en opsporen. Monitoring checkt de algemene gezondheid en beschikbaarheid van een systeem.


\subsection{\IfLanguageName{dutch}{Niet-functionele Requirements}{Niet-functionele Requirements}}
\label{subsec:Niet-functionele Requirements}
Een niet-functionele requirement is een kwaliteitseis voor het systeem. Dit gaat dan meer over voorkeuren.

\subsubsection{\IfLanguageName{dutch}{Open source}{Open source}}
\label{subsubsec:Open source}
Open source verwijst naar source code die publiekelijk toegankelijk is en die door iedereen gebruikt mag worden zonder nodige licentie~\autocite{2021c}. %(https://opensource.com/resources/what-open-source)

\subsubsection{\IfLanguageName{dutch}{Anno 2020-2021}{Anno 2020-2021}}
\label{subsubsec:Anno 2020-2021}
Een belangrijke requirement is dat de oplossing up-to-date moet zijn. In dit onderzoek zal er geen gebruik gemaakt worden van achterhaalde, oude tools. Het is belangrijk dat de tool futureproof kan zijn en zeker nog jaren kan meegaan.

\subsubsection{\IfLanguageName{dutch}{Grafische interface}{Grafische interface}}
\label{subsubsec:Grafische interface}
Een gemakkelijk te gebruiken interface is zeker een meerwaarde bij het monitoren en beheren van een cluster. Als er geen specialist aanwezig is, kan de grafische interface soms voor wat extra duidelijkheid zorgen.


\section{\IfLanguageName{dutch}{Indelen requirements volgens MoSCoW-techniek}{Indelen requirements volgens MoSCoW-techniek}}
\label{sec:Indelen requirements volgens MoSCoW-techniek}

Na het opstellen van de verschillende requirements kunnen we deze nog eens indelen volgens de MoSCoW-techniek~\autocite{Ahmad2017}. Hierin worden de requirements geprioritiseerd in 4 categorieën. “Must have”, “Should have”, “Could have”, ”Won't have” Hierin zijn de “Must have”-requirements verplicht aanwezig. De “Should have”-requirements zijn geen verplichting, maar zijn het liefst wel aanwezig in de keuze van een oplossing. De “Could have”-requirements zijn volledig optioneel en zijn dus niet geheel relevant bij het kiezen van de oplossing. Het “Won't have” aspect laten we hier achterwege, omdat dit geen invloed zal hebben op de keuze van een oplossing.

\begin{description}
    \item[$\bullet$ Must have] 
        \begin{description}
            \item
            \item[$\cdot$] Ondersteuning van redundancy
            \item[$\cdot$] Ondersteuning van failover
            \item[$\cdot$] Ondersteuning van monitoring
        \end{description}
    \item[$\bullet$ Should have]
            \begin{description}
        \item
        \item[$\cdot$] Ondersteuning in 2020-2021
        \item[$\cdot$] Open source
    \end{description}
    \item[$\bullet$ Could have]
                \begin{description}
        \item
        \item[$\cdot$] Grafische interface
        \item[$\cdot$] Zo weinig mogelijk manuele interventie

    \end{description}
\end{description}

\section{\IfLanguageName{dutch}{Hoe beantwoorden de verschillende oplossingen aan de bovenstaande requirements}{Hoe beantwoorden de verschillende oplossingen aan de requirements}}
\label{sec:Hoe beantwoorden de verschillende oplossingen aan de bovenstaande requirements}

In dit gedeelte worden de verschillende oplossingen vergeleken aan de hand van de vooropgestelde requirements. Wanneer een oplossing een zeer brede implementatie heeft van een requirement zal deze aan de hand van een puntensysteem een 5/5 krijgen. Wanneer er niet voldoende implementatie aanwezig is voor deze oplossing, zal dit een 1/5 zijn. De functionele requirements zullen zwaarder doorwegen dan de niet-functionele requirements. Hierbij zal het totaal aantal punten op 20 staan, waarbij de functionele requirements 75\% van de totaalscore bevatten. Dit staat gelijk aan 15/20. De niet-functionele requirements staan dus maar op 25\%, wat gelijk staat aan 5/20 van de totaalscore. Hierbij kan er een goed beeld gevormd worden welke oplossing er functioneler is. Belangrijke niet-functionele requirement is dat de oplossing up-to-date moet zijn, anno 2020-2021. Als de oplossing hier niet aan voldoet, dan zal deze niet doorkomen, of gebruikt worden als proof of concept.

% https://scalegrid.io/blog/managing-high-availability-in-postgresql-part-3/#:~:text=Patroni%20ensures%20the%20end%2Dto,be%20customized%20to%20your%20needs.

% https://www.slideshare.net/ScaleGrid/whats-the-best-postgresql-high-availability-framework-paf-vs-repmgr-vs-patroni-infographic

%In deze links worden 3 oplossingen vergeleken met elkaar

\subsection{\IfLanguageName{dutch}{Oplossing 1: Patroni}{Oplossing 1: Patroni}}
\label{subsec: Oplossing 1: Patroni}

\subsubsection{\IfLanguageName{dutch}{Must have}{Must have}}
\label{subsubsec:Must have}

Voor replicatie opties bestaan er verschillende tools zoals barman, Wal-E, die zullen helpen om nodes toe te voegen aan de cluster. Er kan ook gekozen worden van waar sommige nodes hun data zullen halen. Patroni Patroni gebruikt PostgreSQL streaming replicatie en ondersteunt zowel synchrone als asynchrone replicatie. Standaard wordt asynchrone replicatie geconfigureerd, maar dit kan gewijzigd worden naar de noden van de cluster.

Patroni heeft een automatische failover-functie. Hierbij wordt automatisch gekeken welke node de te vervangen node zal vervangen. Na failover zal ook automatisch de gefaalde node terug in de cluster komen.

Patroni heeft een zeer uitgebreide REST API, die gebruikt kan worden om failover, switchover, reloads, restarts, health checks, etc. uit te voeren. Patroni heeft een tool genaamd, ETCD waarmee de gezondheid van een PostgreSQL cluster, de status van knooppunten en andere informatie van de cluster wordt bijgehouden. Tools die hiervoor ook gebruikt worden en semi-gelijkaardige functionaliteiten hebben zijn o.a. Consul en Zookeeper. Er zijn ook tools die uitsluitend als doel monitoring hebben. Hiervan is PGWatch een goed voorbeeld van. PGWatch geeft op een visuele manier informatie weer over de Postgres nodes.

Patroni bevat veel antwoorden op de verschillende 'Must haves'. Redundantie/replicatie kan hier vele vormen aannemen, aangepast aan de noden van de cluster. Failover kan op een automatische manier gebeuren en hoeft niet manueel gedaan te worden. Ook voor monitoring zijn er verschillende tools beschikbaar. Hierbij zijn ETCD, Consul en Zookeeper goed omschreven voorbeelden.
Op basis hiervan krijgt Patroni 12/15 (3 x 4) punten.

\subsubsection{\IfLanguageName{dutch}{Should have}{Should have}}
\label{subsubsec:Should have}

Patroni is ontwikkeld door Zalando en is volledig open source. De volledige source code is online te vinden op github.com en wordt nog steeds geüpdate. Dit is ook een belangrijke vereiste waaraan de oplossing moet doen. Er worden  nog steeds releases gedaan. De laatste release was, tijdens dit schrijven, op 22 februari 2021. Deze release bevatte sommige nieuwe features zoals toegevoegde support voor de REST API bij “TLS keys” en “cipher suite limitations”, maar ook door stabiliteitsverbetering en bugfixes.

Patroni voldoet door zijn open source en recente relevante updates aan de “Should have” requirements. Hierdoor krijgt Patroni 5/5 punten bij “Should have”.

\subsubsection{\IfLanguageName{dutch}{Could have}{Could have}}
\label{subsubsec:Could have}

Patroni kent ook grafische interfaces die gebruikt kunnen worden bij het opzetten van een Patroni PostgreSQL High Availability cluster. Een voorbeeld hiervan is Patroni Environment Setup (PES). Hiermee kan je op Windows eenvoudig, snel en gebruikersvriendelijk een Patroni cluster opzetten.

Patroni kan opgesteld worden op een manier waarbij niet veel manuele interventie nodig is.



\subsection{\IfLanguageName{dutch}{Oplossing 2: Pgpool-II}{Oplossing 2: Pgpool-II}}
\label{subsec: Oplossing 2: Pgpool-II}

\subsubsection{\IfLanguageName{dutch}{Must have}{Must have}}
\label{subsubsec:Must have}

Pgpool-II beschikt over een tool, genaamd Watchdog, die een subproces is van Pgpool-II dat dient om High Availability toe te voegen. Watchdog wordt gebruikt om single points of failure op te lossen door meerdere Pgpool-II nodes te coördineren. Het coördineert meerdere Pgpool-II nodes door informatie met elkaar uit te wisselen. Op die manier kan het zeker zijn dat de database service onaangetast blijft.

Watchdog kan ook remote de gezondheid controleren van de node waarop het is geïnstalleerd door de verbinding met upstream nodes te monitoren. Als de monitoring faalt, behandelt watchdog dit als het falen van een lokale Pgpool-II node en zal het de nodige acties ondernemen.

Pgpool-II kan meerdere nodes beheren en hierin replicatie opzetten om High Availability te verkrijgen.

Pgpool-II voorziet ook automatische failover binnenin Watchdog. Pgpool-II kan ook andere soorten van failover configuraties aan zoals failover\_requires\_consensus of failover\_when\_quorum\_exists. 

Pgpool-II kan aan de hand van Watchdog aan de vooropgestelde “Must haves” voldoen. Pgpool-II krijgt hierdoor 10/15 punten.

\subsubsection{\IfLanguageName{dutch}{Should have}{Should have}}
\label{subsubsec:Should have}

Pgpool-II is een open source project. De source code wordt onderhouden door hun git-repository.
De laatste release van pgpool-II was op 26 november 2020. Hieruit kunnen we ook zeggen dat Pgpool-II nog een geldige, bruikbare oplossing.

Aan de hand hiervan krijgt Pgpool-II 4/5 punten voor “Should have”. Geen 5/5 omdat er (nog) geen update in 2021 is geweest.

\subsubsection{\IfLanguageName{dutch}{Could have}{Could have}}
\label{subsubsec:Could have}
Op eerste zicht is er niet direct een alomgekende grafische interface aanwezig voor Pgpool-II.

Via de tool Watchdog is het mogelijk om bepaalde elementen in Pgpool-II te automatiseren. Automatische failover is hier een voorbeeld van. Doch andere elementen zijn wel nog manueel te configureren.

\subsection{\IfLanguageName{dutch}{Oplossing 3: PostgreSQL Automatic Failover (PAF)}{Oplossing 3: PostgreSQL Automatic Failover (PAF)}}
\label{subsec:Oplossing 3: PostgreSQL Automatic Failover (PAF)}

\subsubsection{\IfLanguageName{dutch}{Must have}{Must have}}
\label{subsubsec:Must have}

PostgreSQL Automatic Failover (PAF) werkt nauw samen met de tool Pacemaker. PAF is in staat om aan Pacemaker te laten zien wat de huidige status is van een node. Bij het optreden van een storing zal Pacemaker automatisch proberen dit te herstellen.
Als de storing niet te herstellen valt, dan zal PAF zorgen voor automatische failover. PAF maakt gebruik van ip-adres failover in plaats van het herstarten van de standby node om verbinding te maken met de nieuwe master tijdens een failover event, wat voordelig is in scenario's waar een gebruiker de standby nodes niet wil herstarten.

PostgreSQL Automatic Failover (PAF) maakt gebruik van synchrone replicatie om te garanderen dat er geen data verloren gaat tijdens een failover.

PostgreSQL Automatic Failover (PAF) voldoet aan de nodige requirements, zeker met de tool Pacemaker is er heel veel mogelijk qua monitoring, failover en replicatie. De score hierbij voor “Must have” is 13/15 punten.

\subsubsection{\IfLanguageName{dutch}{Should have}{Should have}}
\label{subsubsec:Should have}

Ook PostgreSQL Automatic Failover (PAF) is open source.
De laatste release was op 10 maart 2020. Hieruit kunnen we concluderen dat ook deze oplossing nog up-to-date is en bruikbaar voor dit onderzoek. 
Doordat er (nog) geen nieuwe release is in 2021, krijgt PostgreSQL Automatic Failover (PAF) ook 4/5 punten voor “Should have”, en geen 5/5.

\subsubsection{\IfLanguageName{dutch}{Could have}{Could have}}
\label{subsubsec:Could have}

Op eerste zicht lijkt er niet direct een alomgekende grafische interface aanwezig te zijn voor PostgreSQL Automatic Failover (PAF).

PostgreSQL Automatic Failover (PAF) kan zo geconfigureerd worden dat het weinig tot geen manuele interventie vereist. Aan de hand van bijvoorbeld Pacemaker is dit mogelijk.



\subsection{\IfLanguageName{dutch}{Oplossing 4: Replication Manager (RepMgr)}{Oplossing 4: Replication Manager (RepMgr)}}
\label{subsec:Oplossing 4: Replication Manager (RepMgr)}

\subsubsection{\IfLanguageName{dutch}{Must have}{Must have}}
\label{subsubsec:Must have}
Replication Manager (RepMgr) is een oplossing ontwikkeld voor het beheren van replicatie en failover van PostgreSQL clusters. Het biedt de tools aan om replicatie van PostgreSQL op te zetten, te configureren, te beheren en te monitoren. Het laat ook toe om handmatige omschakeling en failover taken uit te voeren met behulp van repmgr utility. Dit is een gratis tool die ondersteuning en verbetering biedt van PostgreSQL's ingebouwde streaming replicatie.
Voorbeelden van tools zijn repmgr en repmgrd.
Replication Manager (RepMgr) biedt ook de tools om primary en standby nodes op te zetten, en om in geval van faalscenario automatische failover te doen.

De functionaliteiten van Replication Manager (RepMgr) sluiten voldoende aan op de vooropgestelde “Must haves” en krijgt hiervoor 12/15 punten.

\subsubsection{\IfLanguageName{dutch}{Should have}{Should have}}
\label{subsubsec:Should have}

Replication Manager (RepMgr) is open source, ontwikkeld door 2ndQuadrant.
De laatste release was op 22 oktober 2020.

Replication Manager (RepMgr) krijgt hierdoor een score van 4/5 voor “Should have”. Doordat er (nog) geen release is in 2021, krijgt het geen 5/5.

\subsubsection{\IfLanguageName{dutch}{Could have}{Could have}}
\label{subsubsec:Could have}
Op eerste zicht lijkt er niet direct een alomgekende grafische interface aanwezig te zijn voor Replication Manager (repmgr).

Bij Replication Manager (repmgr) is er nog veel dat manueel moet gedaan worden.

\section{\IfLanguageName{dutch}{Resultatenanalyse}{Resultatenanalyse}}
\label{sec:Resultatenanalyse}

\subsection{\IfLanguageName{dutch}{Resultaten requirements}{Resultaten requirements}}
\label{subsec:Resultaten requirements}

In onderstaande tabellen wordt de onderverdeling van de punten van de verschillende oplossingen duidelijk gemaakt. Bij “Must have” zijn er 3 items waar per item 5 punten te verdienen zijn. “Should have” kent 2 items, die samen voor 5 punten meetellen (2 x 2.5). De “Could have” items worden niet meegerekend omdat deze van geen belang zijn geweest in de keuze naar een oplossing. Het totaal van de punten staat op 20. De twee oplossingen met de hoogste score zullen gebruikt worden voor een nog meer verdiepende studie die meer in detail gaat bij deze twee oplossingen. De oplossing met de hoogste score zal ook gebruikt worden bij het opzetten van de proof-of-concept.

\begin{tabular}{ |p{6cm}||p{6cm}|  }
    \hline
    \multicolumn{2}{|c|}{Requirementanalyse Patroni} \\
    \hline
    Must have & \\
    \hline
    Ondersteuning van redundancy  & 4 \\
    Ondersteuning van failover &  4 \\
    Ondersteuning van monitoring & 4 \\
    \hline
    Should have & \\
    \hline
   Open Source &  2.5 \\
   Ondersteuning in 2020-2021 & 2.5 \\
    \hline
    \hline
    Totaal & 17/20 \\
    \hline
\end{tabular}


\caption[Tabel 1: Requirementanalyse Patroni]
\newline

\begin{tabular}{ |p{6cm}||p{6cm}|  }
    \hline
    \multicolumn{2}{|c|}{Requirementanalyse Pgpool-II} \\
    \hline
    Must have & \\
    \hline
    Ondersteuning van redundancy  & 3 \\
    Ondersteuning van failover &  4 \\
    Ondersteuning van monitoring & 3 \\
    \hline
    Should have & \\
    \hline
    Open Source &  2.5 \\
    Ondersteuning in 2020-2021 & 1.5 \\
    \hline
    \hline
    Totaal & 14/20 \\
    \hline
\end{tabular}


\caption[Tabel 2: Requirementanalyse Pgpool-II]{test}
\newline

\begin{tabular}{ |p{6cm}||p{6cm}|  }
    \hline
    \multicolumn{2}{|c|}{Requirementanalyse PostgreSQL Automatic Failover (PAF)} \\
    \hline
    Must have & \\
    \hline
    Ondersteuning van redundancy  & 4 \\
    Ondersteuning van failover &  4 \\
    Ondersteuning van monitoring & 4 \\
    \hline
    Should have & \\
    \hline
    Open Source &  2.5 \\
    Ondersteuning in 2020-2021 & 1.5 \\
    \hline
    \hline
    Totaal & 16/20 \\
    \hline
\end{tabular}


\caption[Tabel 3: Requirementanalyse PostgreSQL Automatic Failover (PAF)]
\newline

\begin{tabular}{ |p{6cm}||p{6cm}|  }
    \hline
    \multicolumn{2}{|c|}{Requirementanalyse Replication Manager (repmgr)} \\
    \hline
    Must have & \\
    \hline
    Ondersteuning van redundancy  & 4 \\
    Ondersteuning van failover &  4 \\
    Ondersteuning van monitoring & 3 \\
    \hline
    Should have & \\
    \hline
    Open Source &  2.5 \\
    Ondersteuning in 2020-2021 & 1.5 \\
    \hline
    \hline
    Totaal & 15/20 \\
    \hline
\end{tabular}


\caption[Tabel 4: Requirementanalyse Replication Manager (repmgr)]
\newline



\begin{tabular}{ |p{6cm}||p{6cm}|  }
    \hline
    \multicolumn{2}{|c|}{Requirementanalyse Alle Oplossingen} \\
    \hline
    Patroni & 17/20 \\
    \hline
    Pgpool-II & 14/20 \\
    \hline
    PostgreSQL Automatic Failover (PAF) & 16/20 \\
    \hline
    Replication Manager (repmgr) & 15/20 \\
    \hline
\end{tabular}



\caption[Tabel 5: Requirementanalyse alle oplossingen]
\newline

In de laatste tabel is er een duidelijke onderverdeling in score van de oplossingen. In dit onderzoek zal verder verdiept worden in Patroni en PostgreSQL Automatic Failover en bijhorende tools. Voor proof of concept zal gebruik worden gemaakt van Patroni.
% Hierin zeggen hoeveel punten elke oplossing heeft enz